class CTxnLocal[ T ] {
    def set( x: T )( implicit t: Txn ): Unit = {}
    def get( implicit t: Txn ) : T = null.asInstanceOf[ T ]
    def initialValue( t: Txn ) : T = null.asInstanceOf[ T ]
}

trait Txn

trait ProcTxn {
    def ccstm: Txn
}

trait TxnLocal[ @specialized T ] {
   def apply()( implicit tx: ProcTxn ) : T
   def set( v: T )( implicit tx: ProcTxn ) : Unit
   def swap( v: T )( implicit tx: ProcTxn ) : T
   def transform( f: T => T )( implicit tx: ProcTxn ) : Unit
}

object TxnLocal {
   def apply[ @specialized T ] : TxnLocal[ T ] = new Impl( new CTxnLocal[ T ])
   def apply[ @specialized T ]( initValue: => T ) : TxnLocal[ T ] = new Impl( new CTxnLocal[ T ] {
      override def initialValue( tx: Txn ): T = initValue
   })

   private class Impl[ T ]( c: CTxnLocal[ T ]) extends TxnLocal[ T ] {
      def apply()( implicit tx: ProcTxn ) : T = c.get( tx.ccstm )
      def set( v: T )( implicit tx: ProcTxn ) : Unit = c.set( v )( tx.ccstm )
      def swap( v: T )( implicit tx: ProcTxn ) : T = {
         // currently not implemented in CTxnLocal
         val oldV = apply()
         set( v )
         oldV
      }
      def transform( f: T => T )( implicit tx: ProcTxn ): Unit = {
         set( f( apply() ))
      }
   }
}


object Transition {
   private val currentRef = TxnLocal[ Transition ]( Instant )
   def current( implicit tx: ProcTxn ) : Transition = currentRef()
}

sealed abstract class Transition
case object Instant extends Transition

-----
ScalaFile
  ScClass: CTxnLocal
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(class)('class')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('CTxnLocal')
    TypeParameterClause
      PsiElement([)('[')
      PsiWhiteSpace(' ')
      TypeParameter: T
        PsiElement(identifier)('T')
      PsiWhiteSpace(' ')
      PsiElement(])(']')
    PrimaryConstructor
      AnnotationsList
        <empty list>
      Modifiers
        <empty list>
      Parameters
        <empty list>
    PsiWhiteSpace(' ')
    ExtendsBlock
      ScTemplateBody
        PsiElement({)('{')
        PsiWhiteSpace('\n    ')
        ScFunctionDefinition: set
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('set')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: x
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('x')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: T
                    CodeReferenceElement: T
                      PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement())(')')
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: t
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('t')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: Txn
                    CodeReferenceElement: Txn
                      PsiElement(identifier)('Txn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: Unit
            CodeReferenceElement: Unit
              PsiElement(identifier)('Unit')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          BlockExpression
            PsiElement({)('{')
            PsiElement(})('}')
        PsiWhiteSpace('\n    ')
        ScFunctionDefinition: get
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('get')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: t
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('t')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: Txn
                    CodeReferenceElement: Txn
                      PsiElement(identifier)('Txn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: T
            CodeReferenceElement: T
              PsiElement(identifier)('T')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          GenericCall
            ReferenceExpression: null.asInstanceOf
              NullLiteral
                PsiElement(null)('null')
              PsiElement(.)('.')
              PsiElement(identifier)('asInstanceOf')
            TypeArgumentsList
              PsiElement([)('[')
              PsiWhiteSpace(' ')
              SimpleType: T
                CodeReferenceElement: T
                  PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement(])(']')
        PsiWhiteSpace('\n    ')
        ScFunctionDefinition: initialValue
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('initialValue')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: t
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('t')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: Txn
                    CodeReferenceElement: Txn
                      PsiElement(identifier)('Txn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: T
            CodeReferenceElement: T
              PsiElement(identifier)('T')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          GenericCall
            ReferenceExpression: null.asInstanceOf
              NullLiteral
                PsiElement(null)('null')
              PsiElement(.)('.')
              PsiElement(identifier)('asInstanceOf')
            TypeArgumentsList
              PsiElement([)('[')
              PsiWhiteSpace(' ')
              SimpleType: T
                CodeReferenceElement: T
                  PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement(])(']')
        PsiWhiteSpace('\n')
        PsiElement(})('}')
  PsiWhiteSpace('\n\n')
  ScTrait: Txn
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(trait)('trait')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('Txn')
    ExtendsBlock
      <empty list>
  PsiWhiteSpace('\n\n')
  ScTrait: ProcTxn
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(trait)('trait')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('ProcTxn')
    PsiWhiteSpace(' ')
    ExtendsBlock
      ScTemplateBody
        PsiElement({)('{')
        PsiWhiteSpace('\n    ')
        ScFunctionDeclaration: ccstm
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('ccstm')
          Parameters
            <empty list>
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: Txn
            CodeReferenceElement: Txn
              PsiElement(identifier)('Txn')
        PsiWhiteSpace('\n')
        PsiElement(})('}')
  PsiWhiteSpace('\n\n')
  ScTrait: TxnLocal
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(trait)('trait')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('TxnLocal')
    TypeParameterClause
      PsiElement([)('[')
      PsiWhiteSpace(' ')
      TypeParameter: T
        AnnotationsList
          Annotation
            PsiElement(@)('@')
            AnnotationExpression
              ConstructorInvocation
                SimpleType: specialized
                  CodeReferenceElement: specialized
                    PsiElement(identifier)('specialized')
        PsiWhiteSpace(' ')
        PsiElement(identifier)('T')
      PsiWhiteSpace(' ')
      PsiElement(])(']')
    PsiWhiteSpace(' ')
    ExtendsBlock
      ScTemplateBody
        PsiElement({)('{')
        PsiWhiteSpace('\n   ')
        ScFunctionDeclaration: apply
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('apply')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiElement())(')')
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: tx
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('tx')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: ProcTxn
                    CodeReferenceElement: ProcTxn
                      PsiElement(identifier)('ProcTxn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: T
            CodeReferenceElement: T
              PsiElement(identifier)('T')
        PsiWhiteSpace('\n   ')
        ScFunctionDeclaration: set
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('set')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: v
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('v')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: T
                    CodeReferenceElement: T
                      PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement())(')')
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: tx
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('tx')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: ProcTxn
                    CodeReferenceElement: ProcTxn
                      PsiElement(identifier)('ProcTxn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: Unit
            CodeReferenceElement: Unit
              PsiElement(identifier)('Unit')
        PsiWhiteSpace('\n   ')
        ScFunctionDeclaration: swap
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('swap')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: v
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('v')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: T
                    CodeReferenceElement: T
                      PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement())(')')
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: tx
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('tx')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: ProcTxn
                    CodeReferenceElement: ProcTxn
                      PsiElement(identifier)('ProcTxn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: T
            CodeReferenceElement: T
              PsiElement(identifier)('T')
        PsiWhiteSpace('\n   ')
        ScFunctionDeclaration: transform
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('transform')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: f
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('f')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  FunctionalType: T => T
                    SimpleType: T
                      CodeReferenceElement: T
                        PsiElement(identifier)('T')
                    PsiWhiteSpace(' ')
                    PsiElement(=>)('=>')
                    PsiWhiteSpace(' ')
                    SimpleType: T
                      CodeReferenceElement: T
                        PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement())(')')
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: tx
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('tx')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: ProcTxn
                    CodeReferenceElement: ProcTxn
                      PsiElement(identifier)('ProcTxn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: Unit
            CodeReferenceElement: Unit
              PsiElement(identifier)('Unit')
        PsiWhiteSpace('\n')
        PsiElement(})('}')
  PsiWhiteSpace('\n\n')
  ScObject: TxnLocal
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(object)('object')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('TxnLocal')
    PsiWhiteSpace(' ')
    ExtendsBlock
      ScTemplateBody
        PsiElement({)('{')
        PsiWhiteSpace('\n   ')
        ScFunctionDefinition: apply
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('apply')
          TypeParameterClause
            PsiElement([)('[')
            PsiWhiteSpace(' ')
            TypeParameter: T
              AnnotationsList
                Annotation
                  PsiElement(@)('@')
                  AnnotationExpression
                    ConstructorInvocation
                      SimpleType: specialized
                        CodeReferenceElement: specialized
                          PsiElement(identifier)('specialized')
              PsiWhiteSpace(' ')
              PsiElement(identifier)('T')
            PsiWhiteSpace(' ')
            PsiElement(])(']')
          Parameters
            <empty list>
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          ParametrizedType: TxnLocal[ T ]
            SimpleType: TxnLocal
              CodeReferenceElement: TxnLocal
                PsiElement(identifier)('TxnLocal')
            TypeArgumentsList
              PsiElement([)('[')
              PsiWhiteSpace(' ')
              SimpleType: T
                CodeReferenceElement: T
                  PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement(])(']')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          ScNewTemplateDefinition: <anonymous>
            PsiElement(new)('new')
            PsiWhiteSpace(' ')
            ExtendsBlock
              TemplateParents
                ConstructorInvocation
                  SimpleType: Impl
                    CodeReferenceElement: Impl
                      PsiElement(identifier)('Impl')
                  ArgumentList
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    ScNewTemplateDefinition: <anonymous>
                      PsiElement(new)('new')
                      PsiWhiteSpace(' ')
                      ExtendsBlock
                        TemplateParents
                          ConstructorInvocation
                            ParametrizedType: CTxnLocal[ T ]
                              SimpleType: CTxnLocal
                                CodeReferenceElement: CTxnLocal
                                  PsiElement(identifier)('CTxnLocal')
                              TypeArgumentsList
                                PsiElement([)('[')
                                PsiWhiteSpace(' ')
                                SimpleType: T
                                  CodeReferenceElement: T
                                    PsiElement(identifier)('T')
                                PsiWhiteSpace(' ')
                                PsiElement(])(']')
                    PsiElement())(')')
        PsiWhiteSpace('\n   ')
        ScFunctionDefinition: apply
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('apply')
          TypeParameterClause
            PsiElement([)('[')
            PsiWhiteSpace(' ')
            TypeParameter: T
              AnnotationsList
                Annotation
                  PsiElement(@)('@')
                  AnnotationExpression
                    ConstructorInvocation
                      SimpleType: specialized
                        CodeReferenceElement: specialized
                          PsiElement(identifier)('specialized')
              PsiWhiteSpace(' ')
              PsiElement(identifier)('T')
            PsiWhiteSpace(' ')
            PsiElement(])(']')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              Parameter: initValue
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('initValue')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  PsiElement(=>)('=>')
                  PsiWhiteSpace(' ')
                  SimpleType: T
                    CodeReferenceElement: T
                      PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          ParametrizedType: TxnLocal[ T ]
            SimpleType: TxnLocal
              CodeReferenceElement: TxnLocal
                PsiElement(identifier)('TxnLocal')
            TypeArgumentsList
              PsiElement([)('[')
              PsiWhiteSpace(' ')
              SimpleType: T
                CodeReferenceElement: T
                  PsiElement(identifier)('T')
              PsiWhiteSpace(' ')
              PsiElement(])(']')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          ScNewTemplateDefinition: <anonymous>
            PsiElement(new)('new')
            PsiWhiteSpace(' ')
            ExtendsBlock
              TemplateParents
                ConstructorInvocation
                  SimpleType: Impl
                    CodeReferenceElement: Impl
                      PsiElement(identifier)('Impl')
                  ArgumentList
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    ScNewTemplateDefinition: <anonymous>
                      PsiElement(new)('new')
                      PsiWhiteSpace(' ')
                      ExtendsBlock
                        TemplateParents
                          ConstructorInvocation
                            ParametrizedType: CTxnLocal[ T ]
                              SimpleType: CTxnLocal
                                CodeReferenceElement: CTxnLocal
                                  PsiElement(identifier)('CTxnLocal')
                              TypeArgumentsList
                                PsiElement([)('[')
                                PsiWhiteSpace(' ')
                                SimpleType: T
                                  CodeReferenceElement: T
                                    PsiElement(identifier)('T')
                                PsiWhiteSpace(' ')
                                PsiElement(])(']')
                        PsiWhiteSpace(' ')
                        ScTemplateBody
                          PsiElement({)('{')
                          PsiWhiteSpace('\n      ')
                          ScFunctionDefinition: initialValue
                            AnnotationsList
                              <empty list>
                            Modifiers
                              PsiElement(override)('override')
                            PsiWhiteSpace(' ')
                            PsiElement(def)('def')
                            PsiWhiteSpace(' ')
                            PsiElement(identifier)('initialValue')
                            Parameters
                              ParametersClause
                                PsiElement(()('(')
                                PsiWhiteSpace(' ')
                                Parameter: tx
                                  AnnotationsList
                                    <empty list>
                                  Modifiers
                                    <empty list>
                                  PsiElement(identifier)('tx')
                                  PsiElement(:)(':')
                                  PsiWhiteSpace(' ')
                                  ParameterType
                                    SimpleType: Txn
                                      CodeReferenceElement: Txn
                                        PsiElement(identifier)('Txn')
                                PsiWhiteSpace(' ')
                                PsiElement())(')')
                            PsiElement(:)(':')
                            PsiWhiteSpace(' ')
                            SimpleType: T
                              CodeReferenceElement: T
                                PsiElement(identifier)('T')
                            PsiWhiteSpace(' ')
                            PsiElement(=)('=')
                            PsiWhiteSpace(' ')
                            ReferenceExpression: initValue
                              PsiElement(identifier)('initValue')
                          PsiWhiteSpace('\n   ')
                          PsiElement(})('}')
                    PsiElement())(')')
        PsiWhiteSpace('\n\n   ')
        ScClass: Impl
          AnnotationsList
            <empty list>
          Modifiers
            AccessModifier
              PsiElement(private)('private')
          PsiWhiteSpace(' ')
          PsiElement(class)('class')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('Impl')
          TypeParameterClause
            PsiElement([)('[')
            PsiWhiteSpace(' ')
            TypeParameter: T
              PsiElement(identifier)('T')
            PsiWhiteSpace(' ')
            PsiElement(])(']')
          PrimaryConstructor
            AnnotationsList
              <empty list>
            Modifiers
              <empty list>
            Parameters
              ParametersClause
                PsiElement(()('(')
                PsiWhiteSpace(' ')
                ClassParameter: c
                  AnnotationsList
                    <empty list>
                  Modifiers
                    <empty list>
                  PsiElement(identifier)('c')
                  PsiElement(:)(':')
                  PsiWhiteSpace(' ')
                  ParameterType
                    ParametrizedType: CTxnLocal[ T ]
                      SimpleType: CTxnLocal
                        CodeReferenceElement: CTxnLocal
                          PsiElement(identifier)('CTxnLocal')
                      TypeArgumentsList
                        PsiElement([)('[')
                        PsiWhiteSpace(' ')
                        SimpleType: T
                          CodeReferenceElement: T
                            PsiElement(identifier)('T')
                        PsiWhiteSpace(' ')
                        PsiElement(])(']')
                PsiElement())(')')
          PsiWhiteSpace(' ')
          ExtendsBlock
            PsiElement(extends)('extends')
            PsiWhiteSpace(' ')
            TemplateParents
              ConstructorInvocation
                ParametrizedType: TxnLocal[ T ]
                  SimpleType: TxnLocal
                    CodeReferenceElement: TxnLocal
                      PsiElement(identifier)('TxnLocal')
                  TypeArgumentsList
                    PsiElement([)('[')
                    PsiWhiteSpace(' ')
                    SimpleType: T
                      CodeReferenceElement: T
                        PsiElement(identifier)('T')
                    PsiWhiteSpace(' ')
                    PsiElement(])(']')
            PsiWhiteSpace(' ')
            ScTemplateBody
              PsiElement({)('{')
              PsiWhiteSpace('\n      ')
              ScFunctionDefinition: apply
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(def)('def')
                PsiWhiteSpace(' ')
                PsiElement(identifier)('apply')
                Parameters
                  ParametersClause
                    PsiElement(()('(')
                    PsiElement())(')')
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    PsiElement(implicit)('implicit')
                    PsiWhiteSpace(' ')
                    Parameter: tx
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('tx')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: ProcTxn
                          CodeReferenceElement: ProcTxn
                            PsiElement(identifier)('ProcTxn')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                PsiWhiteSpace(' ')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                SimpleType: T
                  CodeReferenceElement: T
                    PsiElement(identifier)('T')
                PsiWhiteSpace(' ')
                PsiElement(=)('=')
                PsiWhiteSpace(' ')
                MethodCall
                  ReferenceExpression: c.get
                    ReferenceExpression: c
                      PsiElement(identifier)('c')
                    PsiElement(.)('.')
                    PsiElement(identifier)('get')
                  ArgumentList
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    ReferenceExpression: tx.ccstm
                      ReferenceExpression: tx
                        PsiElement(identifier)('tx')
                      PsiElement(.)('.')
                      PsiElement(identifier)('ccstm')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
              PsiWhiteSpace('\n      ')
              ScFunctionDefinition: set
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(def)('def')
                PsiWhiteSpace(' ')
                PsiElement(identifier)('set')
                Parameters
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    Parameter: v
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('v')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: T
                          CodeReferenceElement: T
                            PsiElement(identifier)('T')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    PsiElement(implicit)('implicit')
                    PsiWhiteSpace(' ')
                    Parameter: tx
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('tx')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: ProcTxn
                          CodeReferenceElement: ProcTxn
                            PsiElement(identifier)('ProcTxn')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                PsiWhiteSpace(' ')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                SimpleType: Unit
                  CodeReferenceElement: Unit
                    PsiElement(identifier)('Unit')
                PsiWhiteSpace(' ')
                PsiElement(=)('=')
                PsiWhiteSpace(' ')
                MethodCall
                  MethodCall
                    ReferenceExpression: c.set
                      ReferenceExpression: c
                        PsiElement(identifier)('c')
                      PsiElement(.)('.')
                      PsiElement(identifier)('set')
                    ArgumentList
                      PsiElement(()('(')
                      PsiWhiteSpace(' ')
                      ReferenceExpression: v
                        PsiElement(identifier)('v')
                      PsiWhiteSpace(' ')
                      PsiElement())(')')
                  ArgumentList
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    ReferenceExpression: tx.ccstm
                      ReferenceExpression: tx
                        PsiElement(identifier)('tx')
                      PsiElement(.)('.')
                      PsiElement(identifier)('ccstm')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
              PsiWhiteSpace('\n      ')
              ScFunctionDefinition: swap
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(def)('def')
                PsiWhiteSpace(' ')
                PsiElement(identifier)('swap')
                Parameters
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    Parameter: v
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('v')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: T
                          CodeReferenceElement: T
                            PsiElement(identifier)('T')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    PsiElement(implicit)('implicit')
                    PsiWhiteSpace(' ')
                    Parameter: tx
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('tx')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: ProcTxn
                          CodeReferenceElement: ProcTxn
                            PsiElement(identifier)('ProcTxn')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                PsiWhiteSpace(' ')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                SimpleType: T
                  CodeReferenceElement: T
                    PsiElement(identifier)('T')
                PsiWhiteSpace(' ')
                PsiElement(=)('=')
                PsiWhiteSpace(' ')
                BlockExpression
                  PsiElement({)('{')
                  PsiWhiteSpace('\n         ')
                  ScPatternDefinition: oldV
                    PsiComment(comment)('// currently not implemented in CTxnLocal')
                    PsiWhiteSpace('\n         ')
                    AnnotationsList
                      <empty list>
                    Modifiers
                      <empty list>
                    PsiElement(val)('val')
                    PsiWhiteSpace(' ')
                    ListOfPatterns
                      ReferencePattern: oldV
                        PsiElement(identifier)('oldV')
                    PsiWhiteSpace(' ')
                    PsiElement(=)('=')
                    PsiWhiteSpace(' ')
                    MethodCall
                      ReferenceExpression: apply
                        PsiElement(identifier)('apply')
                      ArgumentList
                        PsiElement(()('(')
                        PsiElement())(')')
                  PsiWhiteSpace('\n         ')
                  MethodCall
                    ReferenceExpression: set
                      PsiElement(identifier)('set')
                    ArgumentList
                      PsiElement(()('(')
                      PsiWhiteSpace(' ')
                      ReferenceExpression: v
                        PsiElement(identifier)('v')
                      PsiWhiteSpace(' ')
                      PsiElement())(')')
                  PsiWhiteSpace('\n         ')
                  ReferenceExpression: oldV
                    PsiElement(identifier)('oldV')
                  PsiWhiteSpace('\n      ')
                  PsiElement(})('}')
              PsiWhiteSpace('\n      ')
              ScFunctionDefinition: transform
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(def)('def')
                PsiWhiteSpace(' ')
                PsiElement(identifier)('transform')
                Parameters
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    Parameter: f
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('f')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        FunctionalType: T => T
                          SimpleType: T
                            CodeReferenceElement: T
                              PsiElement(identifier)('T')
                          PsiWhiteSpace(' ')
                          PsiElement(=>)('=>')
                          PsiWhiteSpace(' ')
                          SimpleType: T
                            CodeReferenceElement: T
                              PsiElement(identifier)('T')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                  ParametersClause
                    PsiElement(()('(')
                    PsiWhiteSpace(' ')
                    PsiElement(implicit)('implicit')
                    PsiWhiteSpace(' ')
                    Parameter: tx
                      AnnotationsList
                        <empty list>
                      Modifiers
                        <empty list>
                      PsiElement(identifier)('tx')
                      PsiElement(:)(':')
                      PsiWhiteSpace(' ')
                      ParameterType
                        SimpleType: ProcTxn
                          CodeReferenceElement: ProcTxn
                            PsiElement(identifier)('ProcTxn')
                    PsiWhiteSpace(' ')
                    PsiElement())(')')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                SimpleType: Unit
                  CodeReferenceElement: Unit
                    PsiElement(identifier)('Unit')
                PsiWhiteSpace(' ')
                PsiElement(=)('=')
                PsiWhiteSpace(' ')
                BlockExpression
                  PsiElement({)('{')
                  PsiWhiteSpace('\n         ')
                  MethodCall
                    ReferenceExpression: set
                      PsiElement(identifier)('set')
                    ArgumentList
                      PsiElement(()('(')
                      PsiWhiteSpace(' ')
                      MethodCall
                        ReferenceExpression: f
                          PsiElement(identifier)('f')
                        ArgumentList
                          PsiElement(()('(')
                          PsiWhiteSpace(' ')
                          MethodCall
                            ReferenceExpression: apply
                              PsiElement(identifier)('apply')
                            ArgumentList
                              PsiElement(()('(')
                              PsiElement())(')')
                          PsiWhiteSpace(' ')
                          PsiElement())(')')
                      PsiElement())(')')
                  PsiWhiteSpace('\n      ')
                  PsiElement(})('}')
              PsiWhiteSpace('\n   ')
              PsiElement(})('}')
        PsiWhiteSpace('\n')
        PsiElement(})('}')
  PsiWhiteSpace('\n\n\n')
  ScObject: Transition
    AnnotationsList
      <empty list>
    Modifiers
      <empty list>
    PsiElement(object)('object')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('Transition')
    PsiWhiteSpace(' ')
    ExtendsBlock
      ScTemplateBody
        PsiElement({)('{')
        PsiWhiteSpace('\n   ')
        ScPatternDefinition: currentRef
          AnnotationsList
            <empty list>
          Modifiers
            AccessModifier
              PsiElement(private)('private')
          PsiWhiteSpace(' ')
          PsiElement(val)('val')
          PsiWhiteSpace(' ')
          ListOfPatterns
            ReferencePattern: currentRef
              PsiElement(identifier)('currentRef')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          MethodCall
            GenericCall
              ReferenceExpression: TxnLocal
                PsiElement(identifier)('TxnLocal')
              TypeArgumentsList
                PsiElement([)('[')
                PsiWhiteSpace(' ')
                SimpleType: Transition
                  CodeReferenceElement: Transition
                    PsiElement(identifier)('Transition')
                PsiWhiteSpace(' ')
                PsiElement(])(']')
            ArgumentList
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              ReferenceExpression: Instant
                PsiElement(identifier)('Instant')
              PsiWhiteSpace(' ')
              PsiElement())(')')
        PsiWhiteSpace('\n   ')
        ScFunctionDefinition: current
          AnnotationsList
            <empty list>
          Modifiers
            <empty list>
          PsiElement(def)('def')
          PsiWhiteSpace(' ')
          PsiElement(identifier)('current')
          Parameters
            ParametersClause
              PsiElement(()('(')
              PsiWhiteSpace(' ')
              PsiElement(implicit)('implicit')
              PsiWhiteSpace(' ')
              Parameter: tx
                AnnotationsList
                  <empty list>
                Modifiers
                  <empty list>
                PsiElement(identifier)('tx')
                PsiElement(:)(':')
                PsiWhiteSpace(' ')
                ParameterType
                  SimpleType: ProcTxn
                    CodeReferenceElement: ProcTxn
                      PsiElement(identifier)('ProcTxn')
              PsiWhiteSpace(' ')
              PsiElement())(')')
          PsiWhiteSpace(' ')
          PsiElement(:)(':')
          PsiWhiteSpace(' ')
          SimpleType: Transition
            CodeReferenceElement: Transition
              PsiElement(identifier)('Transition')
          PsiWhiteSpace(' ')
          PsiElement(=)('=')
          PsiWhiteSpace(' ')
          MethodCall
            ReferenceExpression: currentRef
              PsiElement(identifier)('currentRef')
            ArgumentList
              PsiElement(()('(')
              PsiElement())(')')
        PsiWhiteSpace('\n')
        PsiElement(})('}')
  PsiWhiteSpace('\n\n')
  ScClass: Transition
    AnnotationsList
      <empty list>
    Modifiers
      PsiElement(sealed)('sealed')
      PsiWhiteSpace(' ')
      PsiElement(abstract)('abstract')
    PsiWhiteSpace(' ')
    PsiElement(class)('class')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('Transition')
    PrimaryConstructor
      AnnotationsList
        <empty list>
      Modifiers
        <empty list>
      Parameters
        <empty list>
    ExtendsBlock
      <empty list>
  PsiWhiteSpace('\n')
  ScObject: Instant
    AnnotationsList
      <empty list>
    Modifiers
      PsiElement(case)('case')
    PsiWhiteSpace(' ')
    PsiElement(object)('object')
    PsiWhiteSpace(' ')
    PsiElement(identifier)('Instant')
    PsiWhiteSpace(' ')
    ExtendsBlock
      PsiElement(extends)('extends')
      PsiWhiteSpace(' ')
      TemplateParents
        ConstructorInvocation
          SimpleType: Transition
            CodeReferenceElement: Transition
              PsiElement(identifier)('Transition')
