<project name="Generate Java to Scala Conversion tests" default="generate.test">
  <property name="base.dir" value="../../../../../../"/>
  <property name="output.dir" value="${base.dir}/test/org/jetbrains/plugins/scala/conversion/generated"/>
  <property name="testdata.dir" value="${base.dir}/testdata/conversion"/>

  <target name="generate.test" depends="clear.output, move.testdata">
    <script language="javascript"><![CDATA[
       importClass(java.io.File)
       output = project.getProperty("output.dir");
       testData = project.getProperty("testdata.dir");
       fs = project.createDataType("fileset");
       fs.setDir(new File(testData));

       ds = fs.getDirectoryScanner(project);
       srcDirs = ds.getIncludedDirectories();

       for (i = 0; i < srcDirs.length; i++) {
         echo = project.createTask("echo");
         var dirStr = srcDirs[i].toString();
         var convertedDirStr = "";
         if (dirStr != "") {
           var str = "";
           while (dirStr != "") {
             var index = dirStr.indexOf("\\");
             var k = ""
             if (index == -1) {
               k = dirStr.substring(0, dirStr.length());
               dirStr = ""
             } else {
               k = dirStr.substring(0, index);
               dirStr = dirStr.substring(index + 1, dirStr.length());
             }
             if (k != "") {
               convertedDirStr = convertedDirStr + k + "/";
               k = k.substring(0,1).toUpperCase() + k.substring(1, k.length());
               str = str + k;
             }
           }

           fs = project.createDataType("fileset");
           fs.setDir(new File(testData + "/" + convertedDirStr));

           ds = fs.getDirectoryScanner(project);
           files = ds.getIncludedFiles();
           var filesNumber = 0;
           for (j = 0; j < files.length; j++) {
             fstr = files[j].toString();
             if (fstr.indexOf("\\") == -1 && !fstr.startsWith("Source")) filesNumber += 1
           }

           if (filesNumber > 0) {
             className = "JavaToScalaConversion" + str + "Test";
             var text = "package org.jetbrains.plugins.scala.conversion.generated\n\nclass " +
               className + " extends JavaToScalaConversionTestBase " +
               "{\n  //This class was generated by build script, please don't change this\n  ";
             text = text +
               "override def rootPath: String = super.rootPath + \"" + convertedDirStr + "\"";
             for (j = 0; j < files.length; j++) {
               fstr = files[j].toString();
               if (fstr.indexOf("\\") == -1 && !fstr.startsWith("Source")) {
                 text = text + "\n\n  def test" + fstr.substring(0, fstr.indexOf(".")) + " = doTest"
               }
             }
             text = text + "\n}";
             file = new File(output + "/" + className + ".scala");
             file.createNewFile();
             echo.setFile(file);
             echo.addText(text);
             echo.perform();
           }
         }
       }

    ]]></script>
  </target>

  <target name="clear.output">
    <mkdir dir="${output.dir}"/>
    <delete includeemptydirs="true">
      <fileset dir="${output.dir}"/>
    </delete>
    <mkdir dir="${output.dir}"/>
  </target>

  <target name="move.testdata">
     <copy toDir="${base.dir}/classes/production/Scala/testdata">
       <fileset dir="${base.dir}/testdata"/>
     </copy>
    <copy toDir="${base.dir}/classes/test/Scala/testData">
       <fileset dir="${base.dir}/testdata"/>
     </copy>
  </target>
</project>